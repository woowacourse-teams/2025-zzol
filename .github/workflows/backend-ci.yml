name: Backend CI & Build

on:
  # 1. PR 발생 시 자동 실행 (테스트 용도)
  pull_request:
    branches:
      - be/dev
      - be/prod
    paths:
      - "backend/**"
      - ".github/workflows/backend-ci.yml"

  # 2. 다른 워크플로우(Deploy)에서 호출 가능하도록 설정
  workflow_call:
    inputs:
      environment:
        description: 'Deploy environment (optional)'
        required: false
        type: string
    outputs:
      environment:
        description: "Determined environment"
        value: ${{ jobs.ci-build.outputs.environment }}
      repo_owner:
        description: "Repository owner"
        value: ${{ jobs.ci-build.outputs.repo_owner }}
      image_tag:
        description: "Docker image tag"
        value: ${{ jobs.ci-build.outputs.image_tag }}

jobs:
  ci-build:
    runs-on: ubuntu-latest
    # output을 상위 워크플로우로 전달
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      repo_owner: ${{ steps.set-env.outputs.repo_owner }}
      image_tag: ${{ steps.set-env.outputs.image_tag }}
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set deployment environment
        id: set-env
        run: |
          chmod +x ../.github/scripts/validate-deployment.sh
          
          INPUT_ENV="${{ inputs.environment }}"
          
          # PR일 때는 validate-deployment를 패스하고 'test' 환경으로 설정
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
             echo "Running in PR mode - Setting dummy environment for build"
             ENVIRONMENT="test"
          else
             # Deploy에서 호출했을 때는 스크립트로 환경 검증
             ENVIRONMENT=$(../.github/scripts/validate-deployment.sh "${{ github.event_name }}" "${{ github.ref }}" "$INPUT_ENV")
          fi
          
          echo "environment=${ENVIRONMENT}" >> $GITHUB_OUTPUT
          
          REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "repo_owner=${REPO_OWNER}" >> $GITHUB_OUTPUT
          
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          IMAGE_TAG="${ENVIRONMENT}-${SHORT_SHA}"
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'corretto'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Compile Check
        run: ./gradlew compileJava compileTestJava

      - name: Run Tests
        run: ./gradlew test

      - name: Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: backend/build/test-results/test/*.xml
          check_name: "Backend Test Results"

      - name: Build JAR
        run: ./gradlew bootJar

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            backend/build/libs
            backend/docker
            .github/scripts
