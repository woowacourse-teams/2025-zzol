name: Backend Deploy

on:
  push:
    branches:
      - be/dev
      - be/prod
    paths:
      - "backend/**"
      - ".github/workflows/backend-deploy.yml"

  workflow_dispatch:
    inputs:
      environment:
        description: 'Deploy environment'
        required: true
        type: choice
        options:
          - dev
          - prod

jobs:
  deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'corretto'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build JAR
        run: ./gradlew bootJar

      - name: Set deployment environment
        id: set-env
        run: |
          # ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ì— ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
          chmod +x .github/scripts/validate-deployment.sh

          # ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ë° í™˜ê²½ ê²°ì •
          ENVIRONMENT=$(.github/scripts/validate-deployment.sh \
            "${{ github.event_name }}" \
            "${{ github.ref }}" \
            "${{ github.event.inputs.environment }}")

          # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
          echo "ENVIRONMENT=${ENVIRONMENT}" >> $GITHUB_ENV

      - name: Get JAR file name
        id: jar-file
        run: |
          JAR_FILE=$(ls build/libs/*.jar | head -1)
          echo "JAR_FILE=$JAR_FILE" >> $GITHUB_ENV
          echo "JAR_NAME=$(basename $JAR_FILE)" >> $GITHUB_ENV

      # ============================================
      # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ (GitHub Actions)
      # ============================================
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Convert repository owner to lowercase
        run: |
          echo "REPO_OWNER=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: backend/build/libs
          file: backend/docker/app/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ env.REPO_OWNER }}/coffee-shout-backend:${{ env.ENVIRONMENT }}
            ghcr.io/${{ env.REPO_OWNER }}/coffee-shout-backend:${{ env.ENVIRONMENT }}-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ============================================
      # íŒŒì¼ ì „ì†¡ (docker-compose.yml + ë°°í¬ ìŠ¤í¬ë¦½íŠ¸)
      # ============================================
      - name: Transfer files via SCP
        uses: appleboy/scp-action@v1
        # ì£¼ì˜: scp-actionì€ í”„ë¡œì íŠ¸ ë£¨íŠ¸ì—ì„œ ì‹¤í–‰ë˜ë¯€ë¡œ
        # working-directory ì„¤ì •ê³¼ ë¬´ê´€í•˜ê²Œ ì ˆëŒ€ ê²½ë¡œ ì‚¬ìš©
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: backend/docker/${{ env.ENVIRONMENT }}/docker-compose.yml,.github/scripts/deploy-*.sh
          target: /tmp/deploy-${{ env.ENVIRONMENT }}/
          strip_components: 1
          overwrite: true

      # ============================================
      # Docker ë¹Œë“œ ë° ë°°í¬
      # ============================================
      - name: Deploy with Docker Compose
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -e

            ENV=${{ env.ENVIRONMENT }}
            DEPLOY_DIR=~/${ENV}
            TMP_DIR=/tmp/deploy-${ENV}
            SCRIPTS_DIR=${TMP_DIR}/.github/scripts

            echo "=== ðŸš€ Coffee Shout ${ENV} ë°°í¬ ì‹œìž‘ ==="

            # ============================================
            # 1. ë””ë ‰í† ë¦¬ ì¤€ë¹„
            # ============================================
            echo "ðŸ“ 1. ë””ë ‰í† ë¦¬ ì¤€ë¹„ ì¤‘..."
            mkdir -p ${DEPLOY_DIR}

            # ============================================
            # 2. íŒŒì¼ ë³µì‚¬
            # ============================================
            echo "ðŸ“¦ 2. íŒŒì¼ ë³µì‚¬ ì¤‘..."
            cp ${TMP_DIR}/docker/${ENV}/docker-compose.yml ${DEPLOY_DIR}/
            cp ${SCRIPTS_DIR}/deploy-*.sh ${DEPLOY_DIR}/
            chmod +x ${DEPLOY_DIR}/deploy-*.sh

            # ============================================
            # 3. ë„¤íŠ¸ì›Œí¬ ìƒì„±
            # ============================================
            echo "ðŸŒ 3. Docker ë„¤íŠ¸ì›Œí¬ ìƒì„± ì¤‘..."
            docker network create ${ENV}-network 2>/dev/null || echo "Network ${ENV}-network already exists"
            docker network create monitoring-network 2>/dev/null || echo "Network monitoring-network already exists"

            # ============================================
            # 4. í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„±
            # ============================================
            echo "ðŸ” 4. í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„± ì¤‘..."
            REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
            cat > ${DEPLOY_DIR}/.env << EOF
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            IMAGE_TAG=${ENV}
            REGISTRY=ghcr.io/${REPO_OWNER}
            EOF

            # ============================================
            # 5. GHCR ë¡œê·¸ì¸
            # ============================================
            echo "ðŸ” 5. GHCR ë¡œê·¸ì¸ ì¤‘..."
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # ============================================
            # 6. ì¸í”„ë¼ ë°°í¬ (DB, Redis)
            # ============================================
            cd ${DEPLOY_DIR}
            ./deploy-infrastructure.sh ${ENV} ${DEPLOY_DIR}

            # ============================================
            # 7. ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬
            # ============================================
            ./deploy-application.sh ${ENV} ${DEPLOY_DIR} ghcr.io/${REPO_OWNER} ${ENV}

            # ============================================
            # 8. ì •ë¦¬
            # ============================================
            echo "ðŸ§¹ 8. ìž„ì‹œ íŒŒì¼ ì •ë¦¬ ì¤‘..."
            rm -rf ${TMP_DIR}

            echo "=== âœ… Coffee Shout ${ENV} ë°°í¬ ì™„ë£Œ ==="

      # ============================================
      # Health Check
      # ============================================
      # Note: Health checkëŠ” deploy-application.sh ë‚´ë¶€ì—ì„œ ìˆ˜í–‰ë¨
      # ì´ ë‹¨ê³„ëŠ” ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ê°€ ì„±ê³µí–ˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ìš©ë„

      # ============================================
      # ë°°í¬ ìš”ì•½
      # ============================================
      - name: Deployment Summary
        if: always()
        run: |
          echo "### Deployment Summary :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **JAR File:** ${{ env.JAR_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed Components:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ${{ env.ENVIRONMENT }}-app (Spring Boot)" >> $GITHUB_STEP_SUMMARY
          echo "- â„¹ï¸  ${{ env.ENVIRONMENT }}-mysql (no changes)" >> $GITHUB_STEP_SUMMARY
          echo "- â„¹ï¸  ${{ env.ENVIRONMENT }}-redis (no changes)" >> $GITHUB_STEP_SUMMARY
