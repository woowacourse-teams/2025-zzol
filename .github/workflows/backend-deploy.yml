name: Backend Deploy

on:
  push:
    branches:
      - be/dev
      - be/prod
    paths:
      - "backend/**"
      - ".github/workflows/backend-deploy.yml"

  workflow_dispatch:
    inputs:
      environment:
        description: 'Deploy environment'
        required: true
        type: choice
        options:
          - dev
          - prod

jobs:
  deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'corretto'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build JAR
        run: ./gradlew bootJar

      - name: Set deployment environment
        id: set-env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # ìˆ˜ë™ ì‹¤í–‰: ë¸Œëžœì¹˜ì™€ í™˜ê²½ ì¼ì¹˜ ê²€ì¦
            SELECTED_ENV=${{ github.event.inputs.environment }}
            BRANCH_NAME=${{ github.ref }}

            echo "ðŸ” ê²€ì¦ ì¤‘: ë¸Œëžœì¹˜=${BRANCH_NAME}, ì„ íƒí™˜ê²½=${SELECTED_ENV}"

            # ë¸Œëžœì¹˜ì™€ í™˜ê²½ ì¼ì¹˜ ê²€ì¦
            if [[ "$SELECTED_ENV" == "dev" && "$BRANCH_NAME" != "refs/heads/be/dev" ]]; then
              echo "âŒ Error: dev í™˜ê²½ì€ be/dev ë¸Œëžœì¹˜ì—ì„œë§Œ ë°°í¬ ê°€ëŠ¥í•©ë‹ˆë‹¤!"
              echo "í˜„ìž¬ ë¸Œëžœì¹˜: ${BRANCH_NAME}"
              exit 1
            elif [[ "$SELECTED_ENV" == "prod" && "$BRANCH_NAME" != "refs/heads/be/prod" ]]; then
              echo "âŒ Error: prod í™˜ê²½ì€ be/prod ë¸Œëžœì¹˜ì—ì„œë§Œ ë°°í¬ ê°€ëŠ¥í•©ë‹ˆë‹¤!"
              echo "í˜„ìž¬ ë¸Œëžœì¹˜: ${BRANCH_NAME}"
              exit 1
            fi

            echo "ENVIRONMENT=$SELECTED_ENV" >> $GITHUB_ENV
            echo "âœ… ê²€ì¦ ì™„ë£Œ: ${SELECTED_ENV} í™˜ê²½ ë°°í¬ ì§„í–‰"

          elif [[ "${{ github.ref }}" == "refs/heads/be/dev" ]]; then
            echo "ENVIRONMENT=dev" >> $GITHUB_ENV
            echo "âœ… be/dev ë¸Œëžœì¹˜ ê°ì§€: dev í™˜ê²½ ë°°í¬"

          elif [[ "${{ github.ref }}" == "refs/heads/be/prod" ]]; then
            echo "ENVIRONMENT=prod" >> $GITHUB_ENV
            echo "âœ… be/prod ë¸Œëžœì¹˜ ê°ì§€: prod í™˜ê²½ ë°°í¬"

          else
            echo "âŒ Error: ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œëžœì¹˜ìž…ë‹ˆë‹¤!"
            echo "í˜„ìž¬ ë¸Œëžœì¹˜: ${{ github.ref }}"
            echo "ì§€ì› ë¸Œëžœì¹˜: be/dev, be/prod"
            exit 1
          fi

          echo "ðŸš€ Deploying to $ENVIRONMENT environment from branch ${{ github.ref }}"

      - name: Get JAR file name
        id: jar-file
        run: |
          JAR_FILE=$(ls build/libs/*.jar | head -1)
          echo "JAR_FILE=$JAR_FILE" >> $GITHUB_ENV
          echo "JAR_NAME=$(basename $JAR_FILE)" >> $GITHUB_ENV

      # ============================================
      # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ (GitHub Actions)
      # ============================================
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Convert repository owner to lowercase
        run: |
          echo "REPO_OWNER=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: backend/build/libs
          file: backend/docker/app/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ env.REPO_OWNER }}/coffee-shout-backend:${{ env.ENVIRONMENT }}
            ghcr.io/${{ env.REPO_OWNER }}/coffee-shout-backend:${{ env.ENVIRONMENT }}-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ============================================
      # íŒŒì¼ ì „ì†¡ (docker-compose.ymlë§Œ)
      # ============================================
      - name: Transfer files via SCP
        uses: appleboy/scp-action@v1
        # ì£¼ì˜: scp-actionì€ í”„ë¡œì íŠ¸ ë£¨íŠ¸ì—ì„œ ì‹¤í–‰ë˜ë¯€ë¡œ
        # working-directory ì„¤ì •ê³¼ ë¬´ê´€í•˜ê²Œ ì ˆëŒ€ ê²½ë¡œ ì‚¬ìš©
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: backend/docker/${{ env.ENVIRONMENT }}/docker-compose.yml
          target: /tmp/deploy-${{ env.ENVIRONMENT }}/
          strip_components: 1
          overwrite: true

      # ============================================
      # Docker ë¹Œë“œ ë° ë°°í¬
      # ============================================
      - name: Deploy with Docker Compose
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -e

            ENV=${{ env.ENVIRONMENT }}
            DEPLOY_DIR=~/${ENV}
            TMP_DIR=/tmp/deploy-${ENV}

            echo "=== ðŸš€ Coffee Shout ${ENV} ë°°í¬ ì‹œìž‘ ==="

            # ============================================
            # 1. ë””ë ‰í† ë¦¬ ì¤€ë¹„
            # ============================================
            echo "ðŸ“ 1. ë””ë ‰í† ë¦¬ ì¤€ë¹„ ì¤‘..."
            mkdir -p ${DEPLOY_DIR}

            # ============================================
            # 2. íŒŒì¼ ë³µì‚¬
            # ============================================
            echo "ðŸ“¦ 2. íŒŒì¼ ë³µì‚¬ ì¤‘..."

            # docker-compose.yml
            cp ${TMP_DIR}/docker/${ENV}/docker-compose.yml ${DEPLOY_DIR}/

            # ============================================
            # 3. ë„¤íŠ¸ì›Œí¬ ìƒì„±
            # ============================================
            echo "ðŸŒ 3. Docker ë„¤íŠ¸ì›Œí¬ ìƒì„± ì¤‘..."
            docker network create ${ENV}-network 2>/dev/null || echo "Network ${ENV}-network already exists"
            docker network create monitoring-network 2>/dev/null || echo "Network monitoring-network already exists"

            # ============================================
            # 4. í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„±
            # ============================================
            echo "ðŸ” 4. í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„± ì¤‘..."
            REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
            cat > ${DEPLOY_DIR}/.env << EOF
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            IMAGE_TAG=${ENV}
            REGISTRY=ghcr.io/${REPO_OWNER}
            EOF

            # ============================================
            # 5. GHCR ë¡œê·¸ì¸ ë° ì´ë¯¸ì§€ Pull
            # ============================================
            echo "ðŸ³ 5. GHCRì—ì„œ Docker ì´ë¯¸ì§€ Pull ì¤‘..."
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            docker pull ghcr.io/${REPO_OWNER}/coffee-shout-backend:${ENV}

            # ============================================
            # 6. ì»¨í…Œì´ë„ˆ ë°°í¬
            # ============================================
            echo "ðŸš¢ 6. ì»¨í…Œì´ë„ˆ ë°°í¬ ì¤‘..."
            cd ${DEPLOY_DIR}

            # Appë§Œ ìž¬ì‹œìž‘ (DBëŠ” ìœ ì§€)
            docker-compose up -d --no-deps ${ENV}-app

            # ============================================
            # 7. ë°°í¬ í™•ì¸
            # ============================================
            echo "âœ… 7. ë°°í¬ ìƒíƒœ í™•ì¸ ì¤‘..."
            sleep 5
            docker-compose ps

            # ìµœê·¼ ë¡œê·¸ í™•ì¸
            docker-compose logs --tail=50 ${ENV}-app

            # ============================================
            # 8. ì •ë¦¬
            # ============================================
            echo "ðŸ§¹ 8. ìž„ì‹œ íŒŒì¼ ì •ë¦¬ ì¤‘..."
            rm -rf ${TMP_DIR}

            echo "=== âœ… Coffee Shout ${ENV} ë°°í¬ ì™„ë£Œ ==="

      # ============================================
      # Health Check
      # ============================================
      - name: Health Check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            ENV=${{ env.ENVIRONMENT }}
            DEPLOY_DIR=~/${ENV}

            echo "ðŸ¥ Health Check ì‹œìž‘..."
            cd ${DEPLOY_DIR}

            # ì»¨í…Œì´ë„ˆ ì‹¤í–‰ í™•ì¸
            if ! docker-compose ps | grep -q "${ENV}-app.*Up"; then
              echo "âŒ ${ENV}-app ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ ì¤‘ì´ì§€ ì•ŠìŠµë‹ˆë‹¤!"
              docker-compose logs --tail=100 ${ENV}-app
              exit 1
            fi

            # Health endpoint í™•ì¸ (40ì´ˆ ëŒ€ê¸°)
            echo "Waiting for application to be ready..."
            for i in {1..40}; do
              if docker exec ${ENV}-app wget --quiet --tries=1 --spider http://localhost:8080/actuator/health 2>/dev/null; then
                echo "âœ… Application is healthy!"
                exit 0
              fi
              echo "Attempt $i/40: Application not ready yet..."
              sleep 1
            done

            echo "âŒ Health check failed!"
            docker-compose logs --tail=100 ${ENV}-app
            exit 1

      # ============================================
      # ë°°í¬ ìš”ì•½
      # ============================================
      - name: Deployment Summary
        if: always()
        run: |
          echo "### Deployment Summary :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **JAR File:** ${{ env.JAR_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed Components:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ${{ env.ENVIRONMENT }}-app (Spring Boot)" >> $GITHUB_STEP_SUMMARY
          echo "- â„¹ï¸  ${{ env.ENVIRONMENT }}-mysql (no changes)" >> $GITHUB_STEP_SUMMARY
          echo "- â„¹ï¸  ${{ env.ENVIRONMENT }}-redis (no changes)" >> $GITHUB_STEP_SUMMARY
