name: Backend Deploy

on:
  push:
    branches:
      - be/dev
      - be/prod
    paths:
      - "backend/**"
      - ".github/workflows/backend-deploy.yml"

  workflow_dispatch:
    inputs:
      environment:
        description: 'Deploy environment'
        required: true
        type: choice
        options:
          - dev
          - prod

jobs:
  deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'corretto'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build JAR
        run: ./gradlew bootJar

      - name: Set deployment environment
        id: set-env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "ENVIRONMENT=${{ github.event.inputs.environment }}" >> $GITHUB_ENV
          elif [[ "${{ github.ref }}" == "refs/heads/be/dev" ]]; then
            echo "ENVIRONMENT=dev" >> $GITHUB_ENV
          elif [[ "${{ github.ref }}" == "refs/heads/be/prod" ]]; then
            echo "ENVIRONMENT=prod" >> $GITHUB_ENV
          fi
          echo "Deploying to $ENVIRONMENT environment"

      - name: Get JAR file name
        id: jar-file
        run: |
          JAR_FILE=$(ls build/libs/*.jar | head -1)
          echo "JAR_FILE=$JAR_FILE" >> $GITHUB_ENV
          echo "JAR_NAME=$(basename $JAR_FILE)" >> $GITHUB_ENV

      # ============================================
      # íŒŒì¼ ì „ì†¡
      # ============================================
      - name: Transfer files via SCP
        uses: appleboy/scp-action@v1
        # ì£¼ì˜: scp-actionì€ í”„ë¡œì íŠ¸ ë£¨íŠ¸ì—ì„œ ì‹¤í–‰ë˜ë¯€ë¡œ
        # working-directory ì„¤ì •ê³¼ ë¬´ê´€í•˜ê²Œ ì ˆëŒ€ ê²½ë¡œ ì‚¬ìš©
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: |
            backend/build/libs/*.jar
            backend/docker/${{ env.ENVIRONMENT }}/docker-compose.yml
            backend/docker/app/Dockerfile
          target: /tmp/deploy-${{ env.ENVIRONMENT }}/
          strip_components: 1
          overwrite: true

      # ============================================
      # Docker ë¹Œë“œ ë° ë°°í¬
      # ============================================
      - name: Deploy with Docker Compose
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -e

            ENV=${{ env.ENVIRONMENT }}
            DEPLOY_DIR=~/${ENV}
            TMP_DIR=/tmp/deploy-${ENV}

            echo "=== ðŸš€ Coffee Shout ${ENV} ë°°í¬ ì‹œìž‘ ==="

            # ============================================
            # 1. ë””ë ‰í† ë¦¬ ì¤€ë¹„
            # ============================================
            echo "ðŸ“ 1. ë””ë ‰í† ë¦¬ ì¤€ë¹„ ì¤‘..."
            mkdir -p ${DEPLOY_DIR}
            mkdir -p ~/common

            # ============================================
            # 2. íŒŒì¼ ë³µì‚¬
            # ============================================
            echo "ðŸ“¦ 2. íŒŒì¼ ë³µì‚¬ ì¤‘..."

            # JAR íŒŒì¼
            cp ${TMP_DIR}/build/libs/*.jar ${DEPLOY_DIR}/app.jar

            # docker-compose.yml
            cp ${TMP_DIR}/docker/${ENV}/docker-compose.yml ${DEPLOY_DIR}/

            # Dockerfile (ê³µí†µ)
            cp ${TMP_DIR}/docker/app/Dockerfile ~/common/

            # ============================================
            # 3. ë„¤íŠ¸ì›Œí¬ ìƒì„±
            # ============================================
            echo "ðŸŒ 3. Docker ë„¤íŠ¸ì›Œí¬ ìƒì„± ì¤‘..."
            docker network create ${ENV}-network 2>/dev/null || echo "Network ${ENV}-network already exists"
            docker network create monitoring-network 2>/dev/null || echo "Network monitoring-network already exists"

            # ============================================
            # 4. í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„±
            # ============================================
            echo "ðŸ” 4. í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„± ì¤‘..."
            cat > ${DEPLOY_DIR}/.env << 'EOF'
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            EOF

            # ============================================
            # 5. Docker ì´ë¯¸ì§€ ë¹Œë“œ
            # ============================================
            echo "ðŸ³ 5. Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
            cd ${DEPLOY_DIR}
            docker build -t coffee-shout-backend:${ENV} -f ~/common/Dockerfile .

            # ============================================
            # 6. ì»¨í…Œì´ë„ˆ ë°°í¬
            # ============================================
            echo "ðŸš¢ 6. ì»¨í…Œì´ë„ˆ ë°°í¬ ì¤‘..."

            # Appë§Œ ìž¬ì‹œìž‘ (DBëŠ” ìœ ì§€)
            docker-compose up -d --no-deps ${ENV}-app

            # ============================================
            # 7. ë°°í¬ í™•ì¸
            # ============================================
            echo "âœ… 7. ë°°í¬ ìƒíƒœ í™•ì¸ ì¤‘..."
            sleep 5
            docker-compose ps

            # ìµœê·¼ ë¡œê·¸ í™•ì¸
            docker-compose logs --tail=50 ${ENV}-app

            # ============================================
            # 8. ì •ë¦¬
            # ============================================
            echo "ðŸ§¹ 8. ìž„ì‹œ íŒŒì¼ ì •ë¦¬ ì¤‘..."
            rm -rf ${TMP_DIR}

            echo "=== âœ… Coffee Shout ${ENV} ë°°í¬ ì™„ë£Œ ==="

      # ============================================
      # Health Check
      # ============================================
      - name: Health Check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            ENV=${{ env.ENVIRONMENT }}
            DEPLOY_DIR=~/${ENV}

            echo "ðŸ¥ Health Check ì‹œìž‘..."
            cd ${DEPLOY_DIR}

            # ì»¨í…Œì´ë„ˆ ì‹¤í–‰ í™•ì¸
            if ! docker-compose ps | grep -q "${ENV}-app.*Up"; then
              echo "âŒ ${ENV}-app ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ ì¤‘ì´ì§€ ì•ŠìŠµë‹ˆë‹¤!"
              docker-compose logs --tail=100 ${ENV}-app
              exit 1
            fi

            # Health endpoint í™•ì¸ (40ì´ˆ ëŒ€ê¸°)
            echo "Waiting for application to be ready..."
            for i in {1..40}; do
              if docker exec ${ENV}-app wget --quiet --tries=1 --spider http://localhost:8080/actuator/health 2>/dev/null; then
                echo "âœ… Application is healthy!"
                exit 0
              fi
              echo "Attempt $i/40: Application not ready yet..."
              sleep 1
            done

            echo "âŒ Health check failed!"
            docker-compose logs --tail=100 ${ENV}-app
            exit 1

      # ============================================
      # ë°°í¬ ìš”ì•½
      # ============================================
      - name: Deployment Summary
        if: always()
        run: |
          echo "### Deployment Summary :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **JAR File:** ${{ env.JAR_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed Components:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ${{ env.ENVIRONMENT }}-app (Spring Boot)" >> $GITHUB_STEP_SUMMARY
          echo "- â„¹ï¸  ${{ env.ENVIRONMENT }}-mysql (no changes)" >> $GITHUB_STEP_SUMMARY
          echo "- â„¹ï¸  ${{ env.ENVIRONMENT }}-redis (no changes)" >> $GITHUB_STEP_SUMMARY
